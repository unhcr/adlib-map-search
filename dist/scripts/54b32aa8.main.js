function getResults(){$("#map_search_results img").css("opacity",1),$("#map_search_results_table").css("opacity",0),$("#map_search_results_files").text(addCommas(Math.floor(1e4*Math.random())+1)),$("#map_search_results_fonds").text(addCommas(Math.floor(1e4*Math.random())+1)),setTimeout(function(){$("#map_search_results img").delay(300).css("opacity",0),$("#map_search_results_table").delay(300).css("opacity",1)},500)}function addCommas(a){a+="",x=a.split("."),x1=x[0],x2=x.length>1?"."+x[1]:"";for(var b=/(\d+)(\d{3})/;b.test(x1);)x1=x1.replace(b,"$1,$2");return x1+x2}var minYear=1920,maxYear=2016,yearArray=[],leftYear=minYear,rightYear=maxYear,countryArray=[],selectedCountry="";$(document).ready(function(){function a(){value=j.invert(d3.mouse(this)[0]-18),value=Math.round(value),value>=rightYear&&(value=rightYear-1),value<=minYear&&(value=minYear),n.attr("transform",function(){return"translate("+(j(value)+12)+",20)"}),leftYear=value,l.attr("x",function(){return j(leftYear)}).attr("width",function(){return j(rightYear)-j(leftYear)}),o.text(value),$("#fromYear").val(value)}function b(){value=j.invert(d3.mouse(this)[0]-5),value=Math.round(value),value<=leftYear&&(value=leftYear+1),value>=maxYear&&(value=maxYear),q.attr("transform",function(){return"translate("+(j(value)+11)+",20)"}),rightYear=value,l.attr("x",function(){return j(leftYear)}).attr("width",function(){return j(rightYear)-j(leftYear)}),r.text(value),$("#toYear").val(value)}function c(a){$("#map_search_message").hide(),selectedCountry=a,""!=selectedCountry?(d3.selectAll(".country").style("fill",function(b,c){return d3.select(this).attr("id")==a?"#006AB4":"rgb(210, 208, 206)"}),$("#map_search_dropdown").val(a).trigger("change.select2"),$("#map_search_results_name").text($("#map_search_dropdown  option:selected").text()),$("#map_search_results").show(),getResults()):(d3.selectAll(".country").style("fill","rgb(210, 208, 206)"),$("#map_search_dropdown").val(0).trigger("change.select2"),$("#map_search_results").hide())}var d=d3.select("#mapsvg");$("#mapsvg").show(),$("#mapsvg").height($("#mapsvg").width()/2.7),$("#chartsvg").height($("#mapsvg").width()/22),window.onresize=function(a){$("#chartsvg").height($("#mapsvg").width()/22)},window.zoomMap=svgPanZoom("#mapsvg",{zoomEnabled:!0,controlIconsEnabled:!0,fit:!1,center:!0,reset:!1,zoomScaleSensitivity:.3,minZoom:1,maxZoom:6}),$("#map_search_dropdown").select2({placeholder:"Select a country",width:250}).on("change",function(){c(this.value)});var e=d3.select("#map_search_dropdown"),f=(e.selectAll("option"),d.append("g").attr("class","hoverTooltip").attr("opacity",1).attr("transform","translate(0,0)")),g=f.append("rect").attr("x",5).attr("y",-9).attr("width",50).attr("height",18).style("opacity",1).style("stroke","#FFF").style("stroke-opacity",.6).style("fill","#006AB4"),h=f.append("g"),i=h.append("text").attr("x",9).attr("y",4).style("font-size",12).style("font-weight","normal").style("fill","#FFF").text("countryname");f.style("display","none"),d.on("mousemove",function(){var a=d3.mouse(this),b=a[0],c=a[1],d=j.invert(b)+0,e=c-15;f.attr("transform",function(){return"translate("+j(d)+","+e+")"})}),d3.selectAll(".country").style("cursor","pointer").style("fill-opacity",function(){var a=d3.select(this).attr("id"),b=d3.select(this).attr("name");return a&&b&&countryArray.push({id:a,name:b}),1}).on("mouseover",function(a,b){var c=d3.select(this).attr("id");i.text(d3.select(this).attr("name"));var d=h.node().getBBox().width;g.attr("width",d+10),f.style("display","block"),d3.selectAll(".country").style("fill",function(a,b){var d=d3.select(this).attr("id");return d==selectedCountry?"#006AB4":c==d?"#0E75C8":"rgb(210, 208, 206)"})}).on("mouseout",function(a,b){f.style("display","none"),d3.selectAll(".country").style("fill",function(a,b){return d3.select(this).attr("id")==selectedCountry?"#006AB4":"rgb(210, 208, 206)"})}).on("mousedown",function(a,b){var d=d3.select(this).attr("id");d&&c(d)}),countryArray.sort(function(a,b){return d3.ascending(a.name,b.name)}),d3.select("#map_search_dropdown").selectAll("option").data(countryArray).enter().append("option").attr("value",function(a,b){return a.id}).text(function(a,b){return a.name}),d3.select("#mapbg").on("mousedown",function(a,b){c("")}),$("#fromYear").val(minYear),$("#toYear").val(maxYear),$("#fromYear, #toYear").on("change",function(){getResults()}),$("#map_search_results img").css("opacity",1),$("#map_search_results_table").css("opacity",0);var j=d3.scale.linear().domain([minYear,maxYear]).nice(d3.time.year).range([0,1460]),k=d3.select("#chartsvg");k.append("rect").attr("x",function(){return j(leftYear)}).attr("width",function(){return j(rightYear)-j(leftYear)}).attr("y",11).attr("height",50).attr("transform","translate(20,0)").style("fill","transparent").style("stroke","#919090");var l=k.append("rect").attr("x",function(){return j(leftYear)}).attr("width",function(){return j(rightYear)-j(leftYear)}).attr("y",12).attr("height",48).attr("transform","translate(20,0)").style("fill","#D6DCEB").style("stroke","transparent");k.append("g").attr("class","x axis").attr("transform","translate(20,60)").call(d3.svg.axis().scale(j).orient("bottom").ticks(10).tickSubdivide(1).tickFormat(d3.format("d")).tickSize(-50,20,0)),d3.selectAll(".tick text").attr("transform","translate(18,-47)");var a=d3.svg.brush().x(j).extent([0,0]).on("brush",a).on("brushend",function(){getResults()}),b=d3.svg.brush().x(j).extent([0,0]).on("brush",b).on("brushend",function(){getResults()}),m=k.append("g").attr("class","tab").attr("id","left_tab").call(a),n=m.append("g").attr("id","leftTabGrp").attr("transform","translate(12,20)").style("cursor","pointer").on("mouseover",function(){d3.select("#leftTabBg").style("fill","#CAC9CB")}).on("mouseout",function(){d3.select("#leftTabBg").style("fill","#E1DFE0")}),o=n.append("text").attr("class","tabLabel").attr("x",-11).attr("y",-12).text(minYear);n.append("rect").attr("id","leftTabBg").attr("x",0).attr("y",0).attr("width",16).attr("height",30).style("fill","#E1DFE0").style("stroke","#919090"),n.append("line").attr("x1",5).attr("x2",5).attr("y1",5).attr("y2",25).style("stroke","#919090"),n.append("line").attr("x1",10).attr("x2",10).attr("y1",5).attr("y2",25).style("stroke","#919090");var p=k.append("g").attr("class","tab").attr("id","right_tab").call(b),q=p.append("g").attr("transform",function(){return"translate("+(j(maxYear)-j(minYear)+11)+",20)"}).style("cursor","pointer").on("mouseover",function(){d3.select("#rightTabBg").style("fill","#CAC9CB")}).on("mouseout",function(){d3.select("#rightTabBg").style("fill","#E1DFE0")}),r=q.append("text").attr("class","tabLabel").attr("x",3).attr("y",-12).text(maxYear);q.append("rect").attr("id","rightTabBg").attr("x",0).attr("y",0).attr("width",16).attr("height",30).style("fill","#E1DFE0").style("stroke","#919090"),q.append("line").attr("x1",5).attr("x2",5).attr("y1",5).attr("y2",25).style("stroke","#919090"),q.append("line").attr("x1",10).attr("x2",10).attr("y1",5).attr("y2",25).style("stroke","#919090"),$("#map_button_search").on("click",function(){""==selectedCountry?$("#map_search_message").text("No country selected"):$("#map_search_message").text("Search for "+selectedCountry+" from "+leftYear+" to "+rightYear),$("#map_search_message").show()}),$("#map_button_clear").on("click",function(){leftYear=minYear,rightYear=maxYear,c(""),window.zoomMap.reset()})});